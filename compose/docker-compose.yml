# =========================================
# [A] 공통 리소스: 네트워크 / 볼륨
# =========================================
networks:
  shop-net:
    driver: bridge

volumes:
  productdb-data:
  userdb-data:
  cartdb-data:
  orderdb-data:

services:
  # =========================================
  # [B] 데이터베이스 4종 (MariaDB 10.11)
  #  - 각 서비스별 전용 DB 컨테이너
  #  - init.sql은 필요할 때만 마운트
  # =========================================
  product-db:
    image: mariadb:10.11
    container_name: product-db
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: productdb
      MARIADB_USER: user
      MARIADB_PASSWORD: pass
    # 로컬 툴로 DB 접속 필요 없으면 아래 ports는 삭제 가능
    ports:
      - "3307:3306"
    volumes:
      - productdb-data:/var/lib/mysql
      - ./init/product-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "mariadb -uuser -ppass -e 'SELECT 1' productdb || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [shop-net]

  user-db:
    image: mariadb:10.11
    container_name: user-db
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: userdb
      MARIADB_USER: user
      MARIADB_PASSWORD: pass
    ports:
      - "3308:3306"
    volumes:
      - userdb-data:/var/lib/mysql
      - ./init/user-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "mariadb -uuser -ppass -e 'SELECT 1' userdb || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [shop-net]

  cart-db:
    image: mariadb:10.11
    container_name: cart-db
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: cartdb
      MARIADB_USER: user
      MARIADB_PASSWORD: pass
    ports:
      - "3309:3306"
    volumes:
      - cartdb-data:/var/lib/mysql
      - ./init/cart-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "mariadb -uuser -ppass -e 'SELECT 1' cartdb || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [shop-net]

  order-db:
    image: mariadb:10.11
    container_name: order-db
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: orderdb
      MARIADB_USER: user
      MARIADB_PASSWORD: pass
    ports:
      - "3310:3306"
    volumes:
      - orderdb-data:/var/lib/mysql
      - ./init/order-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "mariadb -uuser -ppass -e 'SELECT 1' orderdb || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [shop-net]

  # =========================================
  # [C] 리버스 프록시 (컨테이너 게이트웨이)
  #  - 외부 포트는 여기에서만 노출
  #  - nginx.conf는 서비스명으로 프록시
  # =========================================
  nginx-proxy:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "8080:80"       # 외부 진입점 (예: http://<VM IP>:8080)
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - user-service
      - product-service
      - cart-service
      - order-service
    networks: [shop-net]

  # =========================================
  # [D] 프론트엔드 (정적 서버)
  #  - 외부 포트 미노출 (게이트웨이만 노출)
  # =========================================
  frontend:
    image: khg435/shop-frontend:latest
    container_name: frontend
    expose: ["80"]
    networks: [shop-net]

  # =========================================
  # [E] 백엔드 서비스 - user
  # =========================================
  user-service:
    image: khg435/user-service:latest
    container_name: user-service
    expose: ["8080"]
    depends_on:
      user-db:
        condition: service_healthy
    networks: [shop-net]

  # =========================================
  # [F] 백엔드 서비스 - product
  # =========================================
  product-service:
    image: khg435/product-service:latest
    container_name: product-service
    expose: ["8080"]
    depends_on:
      product-db:
        condition: service_healthy
    networks: [shop-net]

  # =========================================
  # [G] 백엔드 서비스 - cart / order
  #  - 필요 시 환경변수로 컨텍스트 경로 등 조정 가능
  # =========================================
  cart-service:
    image: khg435/cart-service:latest
    container_name: cart-service
    expose: ["8080"]
    environment:
      - SERVER_SERVLET_CONTEXT_PATH=/api
    depends_on:
      cart-db:
        condition: service_healthy
    networks: [shop-net]

  order-service:
    image: khg435/order-service:latest
    container_name: order-service
    expose: ["8080"]
    depends_on:
      order-db:
        condition: service_healthy
    networks: [shop-net]