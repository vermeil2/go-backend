server {
    # [A] 리스닝/서버명
    listen 80 default_server;
    server_name _;

    # [B] 프론트 라우팅(정적은 frontend 컨테이너에서)
    location / {
        proxy_pass http://frontend:80/;
        proxy_redirect off;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # [C] CORS 공통 설정
    set $cors_methods "GET, POST, PUT, DELETE, OPTIONS";
    set $cors_headers "Origin, Content-Type, Accept, Authorization";

    # [D] Products API
    location ~ ^/api/products(/|$) {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods $cors_methods always;
            add_header Access-Control-Allow-Headers $cors_headers always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            return 204;
        }
        proxy_pass http://product-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods $cors_methods always;
        add_header Access-Control-Allow-Headers $cors_headers always;
        add_header Access-Control-Allow-Credentials "true" always;
    }

    # [E] Cart API
    location ~ ^/api/cart(/|$) {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods $cors_methods always;
            add_header Access-Control-Allow-Headers $cors_headers always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            return 204;
        }
        proxy_pass http://cart-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods $cors_methods always;
        add_header Access-Control-Allow-Headers $cors_headers always;
        add_header Access-Control-Allow-Credentials "true" always;
    }

    # [F] Users API
    location ~ ^/api/users(/|$) {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods $cors_methods always;
            add_header Access-Control-Allow-Headers $cors_headers always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            return 204;
        }
        proxy_pass http://user-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods $cors_methods always;
        add_header Access-Control-Allow-Headers $cors_headers always;
        add_header Access-Control-Allow-Credentials "true" always;
    }

    # [G] Orders API
    location ~ ^/api/orders(/|$) {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods $cors_methods always;
            add_header Access-Control-Allow-Headers $cors_headers always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            return 204;
        }
        proxy_pass http://order-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods $cors_methods always;
        add_header Access-Control-Allow-Headers $cors_headers always;
        add_header Access-Control-Allow-Credentials "true" always;
    }
}
